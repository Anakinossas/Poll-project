<!DOCTYPE html>
<html lang="en" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Poll - Insert Email</title>
    <script src="https://kit.fontawesome.com/c20728e86b.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <style>
        #myBar {
            width: 0;
            height: 30px;
            background-color: #198754;
            color: white;
            text-align: center;
            line-height: 30px;
            display: none;
            border-radius: 20px;
        }
    </style>

</head>
<body class="container w-100">

    <div class="row">
        <h1 class="text-center">ZeroPoll</h1>
    </div>

    <span class="d-flex align-items-center justify-content-center mt-5">
        <h4>Welcome,&nbsp;</h4>
        <h4 sec:authentication="name"></h4>
    </span>

    <div class="row d-flex justify-content-center mt-5 gap-5">
        <div class="col-lg-2 w-25 box shadow rounded-2 p-3">
            <h4 class="text-center">Load E-Mails</h4>

            <div class="row d-flex justify-content-center align-items-center mb-3">
                <input id="file" name="file" type="file"/>
            </div>
            <div class="row d-flex justify-content-center align-items-center">
                <button type="button" class="btn-success btn w-50" onclick="loadEmails();">
                    Load e-mails
                </button>
            </div>
        </div>

        <div class="col-lg-2 w-25 box shadow rounded-2 p-3">
            <h4 class="text-center">Password Association</h4>
            <div class="row d-flex justify-content-center align-items-center mb-1">
                <p>Give passwords to the emails imported</p>
            </div>
            <div class="row d-flex justify-content-center align-items-center">
                <button type="button" class="btn-success btn w-50" onclick="move()">
                    Give password
                </button>
            </div>

        </div>
    </div>

    <div class="w-25 m-auto mt-5 row text-center">
        <div>
            <div id="myBar">0%</div>
        </div>
    </div>

    <div class="row mt-5 m-auto w-25 text-center">
        <div class="alert alert-success text-xl" role="alert" id="alert-success" style="display: none">
            Operazione effettuata correttamente con successo <i class="fa-regular fa-circle-check"></i>
        </div>
    </div>

    <div class="row mt-5 m-auto w-25 text-center">
        <div class="alert alert-danger text-xl" role="alert" id="alert-danger" style="display: none">
            Operazione fallita <i class="fa-solid fa-circle-xmark" style="cursor: pointer"></i>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

        let cliccato = 0;

        function loadEmails() {
            cliccato = 1;

            let uploadProdottiField = $("#file");
            let fileToUpload = uploadProdottiField[0].files[0];
            let formData = new FormData();

            if (fileToUpload === undefined) {
                $("#alert-danger").css("display", "block");
            } else {
                formData.append("IMPORT_EMAIL", fileToUpload, fileToUpload.filename);
                let httpReq = new XMLHttpRequest();

                httpReq.onreadystatechange = function () {
                    if (httpReq.readyState === 4) {
                        if (httpReq.status === 200) {
                            alert('Report Email caricato');
                            $("#alert-success").css("display", "block");
                        } else {
                            alert('Errore durante il caricamento');
                            $("#alert-danger").css("display", "block");
                        }
                    }
                }

                httpReq.open("POST", "http://localhost:8080/importEmails");
                httpReq.send(formData);
            }

        }

        function associateEmailWithPassword() {
            cliccato = 0;

            $("#alert-stampa").removeClass("alert-success");
            $("#alert-stampa").removeClass("alert-danger");

            $("#alert-stampa").addClass("alert-secondary");

            $("#icona").addClass("fa-sun");
            $("#icona").addClass("fa-spin");
            $("#icona").removeClass("fa-circle-check");
            $("#icona").removeClass("fa-circle-xmark");

            $("#alert-stampa").css("display", "block");

            let httpReq = new XMLHttpRequest();

            httpReq.onreadystatechange = function () {
                if (httpReq.readyState === 4) {
                    if (httpReq.status === 200) {
                        $("#alert-stampa").removeClass("alert-secondary");
                        $("#alert-stampa").addClass("alert-success");
                        $("#icona").removeClass("fa-sun");
                        $("#icona").removeClass("fa-spin");
                        $("#icona").addClass("fa-circle-check");
                    } else {
                        $("#alert-stampa").removeClass("alert-secondary");
                        $("#alert-stampa").addClass("alert-danger");
                        $("#icona").removeClass("fa-sun");
                        $("#icona").removeClass("fa-spin");
                        $("#icona").addClass("fa-circle-xmark");
                    }
                }
            }

            httpReq.open("GET", "http://localhost:8080/sendMail");
            httpReq.send("Email Spedita");
        }

        let i = 0;

        function move() {
            if (i == 0) {
                i = 1;
                let elem = $("#myBar");
                elem.css("display", "block");

                let width = 0;
                let id = setInterval(frame, 10);

                function frame() {
                    if (width >= 100) {
                        clearInterval(id);

                        if (cliccato === 1) {
                            loadEmails();
                        } else {
                            associateEmailWithPassword();
                        }

                        elem.css("display", "none");

                        i = 0;
                    } else {
                        width++;
                        elem.style.width = width + "%";
                        elem.innerHTML = width + "%";
                    }
                }
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</body>
</html>